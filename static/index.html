<html>
<head>
<link href="css/style.css" rel="stylesheet">
<script src="/socket.io/socket.io.js"></script>
<script type="text/javascript" src="js/g.js" charset="UTF-8"></script>
<script type="text/javascript" src="js/g.web.js" charset="UTF-8"></script>
<script type="text/javascript">

function on_load()
{


var cam = new g.web.gfx.camera();
cam.position([0, 0, 0]);
cam.orientation([0, 0, 0, 1]);

var shadow_map = null;
var light = new g.web.gfx.camera();
light.view([20, 20, 20], [0, -1, 0], [0, 0, 1]);

g.web.canvas(document.getElementsByTagName('canvas')[0]);

g.initialize(function ()
{
    g.is_running = false;

    const asset_list = [
    'shaders/basic_textured.vert',
    'shaders/basic_textured.frag',
    'shaders/basic_colored.vert',
    'shaders/basic_colored.frag',
    'shaders/depth_only.vert',
    'shaders/depth_only.frag',
    'imgs/stars.jpg',
    'imgs/test.png',
    'voxels/squid.json',
    'meshes/plane.json',
    'meshes/exported-cube.json'
    ];

    g.web.assets.load(asset_list,
    function() {
        g.web.gfx.shader.create('basic_textured',
            g.web.assets['shaders/basic_textured.vert'],
            g.web.assets['shaders/basic_textured.frag']
        );

        g.web.gfx.shader.create('basic_colored',
            g.web.assets['shaders/basic_colored.vert'],
            g.web.assets['shaders/basic_colored.frag']
        );

        g.web.gfx.shader.create('depth_only',
            g.web.assets['shaders/depth_only.vert'],
            g.web.assets['shaders/depth_only.frag']
        );

        // g.web.assets['mesh/plane'] = g.web.gfx.mesh.create(g.web.assets["meshes/plane.json"]);
        g.web.assets['mesh/cube'] = g.web.gfx.mesh.create(g.web.assets['meshes/exported-cube.json']);
        g.web.assets['tex/stars'] = g.web.gfx.texture.create(g.web.assets["imgs/stars.jpg"])
                                                     .repeating()
                                                     .pixelated();

        g.web.assets['tex/test'] = g.web.gfx.texture.create(g.web.assets["imgs/test.png"])
                                                     .repeating()
                                                     .pixelated();
        g.is_running = true;
    });

    shadow_map = g.web.gfx.texture.create({width: 512, height: 512}).render_target();
    light.orthographic();

	return true;
});


g.web.pointer.on_move(function (event)
{
    cam.tilt(event.movementY / 100, event.movementX / 100);
});


g.web.on_message(function (msg)
{

});


g.update(function (dt)
{
    const forward = cam.forward();
    const up = cam.up();
    const left = cam.left();

	if (g.web.key.is_pressed('w')) { cam.position(cam.position().add(forward.mul(-dt))); }
    if (g.web.key.is_pressed('s')) { cam.position(cam.position().add(forward.mul(dt))); }
    if (g.web.key.is_pressed('a')) { cam.position(cam.position().add(left.mul(dt))); }
    if (g.web.key.is_pressed('d')) { cam.position(cam.position().add(left.mul(-dt))); }
    if (g.web.key.is_pressed(' ')) { cam.position(cam.position().add(up.mul(dt))); }
    if (g.web.key.is_pressed('shift')) { cam.position(cam.position().add(up.mul(-dt))); }

    if (g.web.key.is_pressed('q')) { cam.tilt(0, 0, dt); }
    if (g.web.key.is_pressed('e')) { cam.tilt(0, 0, -dt); }
});

var t = 0;


const draw_scene_shadow = (camera) => {

    g.web.assets['voxel/squid'].using_shader('depth_only')
        .with_attribute({name:'a_position', buffer: 'positions', components: 3})
        .with_camera(camera)
        .set_uniform('u_model').mat4([].I(4))
        .draw_tris();

    g.web.assets['mesh/exported-cube'].using_shader('depth_only')
        .with_attribute({name:'a_position', buffer: 'positions', components: 3})
        .with_camera(camera)
        .set_uniform('u_model').mat4([].mat_scale([100, 100, 100]))
        .draw_tris();

    g.web.assets['mesh/exported-cube'].using_shader('depth_only')
        .with_attribute({name:'a_position', buffer: 'positions', components: 3})
        .with_camera(camera)
        .set_uniform('u_model').mat4([].translate([0, 10, 0]))
        .draw_tris();

    g.web.assets['mesh/exported-cube'].using_shader('depth_only')
        .with_attribute({name:'a_position', buffer: 'positions', components: 3})
        .with_camera(camera)
        .set_uniform('u_model').mat4([].translate([0, 0, 10]))
        .draw_tris();

    g.web.assets['mesh/exported-cube'].using_shader('depth_only')
        .with_attribute({name:'a_position', buffer: 'positions', components: 3})
        .with_camera(camera)
        .set_uniform('u_model').mat4([].translate([10, 0, 0]))
        .draw_tris();
};


const draw_scene = (camera) => {

    g.web.assets['voxel/squid'].using_shader('basic_colored')
        .with_attribute({name:'a_position', buffer: 'positions', components: 3})
        //.with_attribute({name:'a_normal', buffer: 'normals', components: 3})
        .with_attribute({name:'a_color', buffer: 'colors', components: 3})
        .with_camera(camera)
        .set_uniform('u_model').mat4([].I(4))
        .set_uniform('u_shadow_map').texture(shadow_map)
        .draw_tris();

    g.web.assets['mesh/exported-cube'].using_shader('basic_textured')
        .with_attribute({name:'a_position', buffer: 'positions', components: 3})
        .with_attribute({name:'a_tex_coord', buffer: 'texture_coords', components: 2})
        .with_camera(camera)
        .set_uniform('u_texture').texture(g.web.assets['tex/stars'])
        .set_uniform('u_model').mat4([].mat_scale([100, 100, 100]))
        .draw_tris();

    g.web.assets['mesh/exported-cube'].using_shader('basic_textured')
        .with_attribute({name:'a_position', buffer: 'positions', components: 3})
        .with_attribute({name:'a_tex_coord', buffer: 'texture_coords', components: 2})
        .with_camera(camera)
        .set_uniform('u_texture').texture(g.web.assets['tex/stars'])
        .set_uniform('u_model').mat4([].translate([0, 10, 0]))
        .draw_tris();

    g.web.assets['mesh/exported-cube'].using_shader('basic_textured')
        .with_attribute({name:'a_position', buffer: 'positions', components: 3})
        .with_attribute({name:'a_tex_coord', buffer: 'texture_coords', components: 2})
        .with_camera(camera)
        .set_uniform('u_texture').texture(g.web.assets['tex/test'])
        .set_uniform('u_model').mat4([].translate([0, 0, 10]))
        .draw_tris();

    g.web.assets['mesh/exported-cube'].using_shader('basic_textured')
        .with_attribute({name:'a_position', buffer: 'positions', components: 3})
        .with_attribute({name:'a_tex_coord', buffer: 'texture_coords', components: 2})
        .with_camera(camera)
        .set_uniform('u_texture').texture(shadow_map)//g.web.assets['tex/test'])
        .set_uniform('u_model').mat4([].translate([10, 0, 0]))
        .draw_tris();
};

g.web.draw(function (dt)
{
    t += dt;
    if (g.is_running == false) { return; }


    light.position([Math.cos(t) * 10, -30, 0]);
    shadow_map.bind_as_target();
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
    draw_scene_shadow(light.perspective());
    shadow_map.unbind_as_target();

    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
    draw_scene(cam.perspective());
});

g.start();
}

</script>
</head>

<body style="margin:0" onload="on_load()">
<canvas style="padding:0;margin:0;width:100%;height:100%"></canvas>
</body>
</html>
